<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Web Camera App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      box-sizing: border-box;
    }
    .camera-frame {
      width: 100%;
      max-width: 360px;
      aspect-ratio: 9 / 16;
      background: black;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    video, img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .mode-switch-overlay {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .switch {
      position: relative;
      width: 50px;
      height: 24px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      background: #555;
      border-radius: 24px;
      top: 0; left: 0; right: 0; bottom: 0;
      transition: .3s;
    }
    .slider:before {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      left: 2px;
      bottom: 2px;
      background: white;
      border-radius: 50%;
      transition: .3s;
    }
    input:checked + .slider {
      background: #4caf50;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .button-area {
      margin-top: 10px;
      display: flex;
      gap: 12px;
    }
    #shutterBtn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      background: red;
      font-size: 30px;
      color: white;
    }
    #saveBtn, #deleteBtn, #recordBtn {
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: #333;
      color: #fff;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="camera-frame" id="cameraFrame">
    <video id="camera" autoplay playsinline></video>
    <img id="photoPreview" style="display:none;">
    <div class="mode-switch-overlay">
      <span>üì∑</span>
      <label class="switch">
        <input type="checkbox" id="modeSwitch">
        <span class="slider"></span>
      </label>
      <span>üé•</span>
    </div>
  </div>

  <div class="button-area">
    <button id="shutterBtn">‚óè</button>
    <button id="recordBtn" style="display:none;">Èå≤ÁîªÈñãÂßã</button>
    <button id="saveBtn" style="display:none;">‰øùÂ≠ò</button>
    <button id="deleteBtn" style="display:none;">ÂâäÈô§</button>
  </div>
</div>

<script>
const video = document.getElementById("camera");
const photoPreview = document.getElementById("photoPreview");
const shutterBtn = document.getElementById("shutterBtn");
const saveBtn = document.getElementById("saveBtn");
const deleteBtn = document.getElementById("deleteBtn");
const recordBtn = document.getElementById("recordBtn");
const modeSwitch = document.getElementById("modeSwitch");
const cameraFrame = document.getElementById("cameraFrame");

let stream;
let track;
let photoBlob;
let recorder;
let recordedChunks = [];

async function startCamera() {
  if (location.protocol !== "https:") {
    alert("„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØHTTPS„ÅßÈñã„ÅèÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇGitHub Pages„Å™„Å©„ÅßÂÖ¨Èñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    return;
  }

  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === "videoinput");
    if (videoDevices.length === 0) {
      alert("„Ç´„É°„É©„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
      return;
    }

    const selectedDeviceId = videoDevices[0].deviceId;

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        deviceId: { exact: selectedDeviceId },
        facingMode: "environment"
      },
      audio: true
    });

    video.srcObject = stream;
    track = stream.getVideoTracks()[0];

  } catch (e) {
    console.error("getUserMedia „Ç®„É©„Éº:", e);
    alert("„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç´„É°„É©Ë®±ÂèØË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
  }
}
startCamera();

cameraFrame.addEventListener("click", () => {
  if (!track) return;
  try {
    track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
  } catch (e) {
    console.log("„Éï„Ç©„Éº„Ç´„ÇπÂÜçÈÅ©Áî®„Ç®„É©„Éº:", e);
  }
});

modeSwitch.addEventListener("change", () => {
  if (modeSwitch.checked) {
    shutterBtn.style.display = "none";
    recordBtn.style.display = "inline-block";
  } else {
    shutterBtn.style.display = "inline-block";
    recordBtn.style.display = "none";
  }
});

shutterBtn.addEventListener("click", () => {
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  canvas.toBlob(blob => {
    photoBlob = blob;
    photoPreview.src = URL.createObjectURL(blob);
    video.style.display = "none";
    photoPreview.style.display = "block";
    saveBtn.style.display = "inline-block";
    deleteBtn.style.display = "inline-block";
    shutterBtn.style.display = "none";
  }, "image/jpeg");
});

saveBtn.addEventListener("click", () => {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(photoBlob);
  a.download = "photo.jpg";
  a.click();
});

deleteBtn.addEventListener("click", () => {
  photoPreview.style.display = "none";
  video.style.display = "block";
  saveBtn.style.display = "none";
  deleteBtn.style.display = "none";
  shutterBtn.style.display = "inline-block";
});

recordBtn.addEventListener("click", () => {
  if (recordBtn.textContent === "Èå≤ÁîªÈñãÂßã") {
    recordedChunks = [];
    recorder = new MediaRecorder(stream);
    recorder.ondataavailable = e => recordedChunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: "video/mp4" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "video.mp4";
      a.click();
    };
    recorder.start();
    recordBtn.textContent = "Èå≤ÁîªÂÅúÊ≠¢";
    recordBtn.style.background = "red";
  } else {
    recorder.stop();
    recordBtn.textContent = "Èå≤ÁîªÈñãÂßã";
    recordBtn.style.background = "#333";
  }
});
</script>

</body>
</html>